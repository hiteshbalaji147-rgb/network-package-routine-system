#include <stdio.h>
#include <stdlib.h>
#include <limits.h>

#define MAX 20
#define INF INT_MAX

int graph[MAX][MAX], n;

// Function to find minimum distance vertex
int minDistance(int dist[], int visited[]) {
    int min = INF, minIndex = -1;
    for (int i = 0; i < n; i++) {
        if (!visited[i] && dist[i] < min) {
            min = dist[i];
            minIndex = i;
        }
    }
    return minIndex;
}

// Print path recursively
void printPath(int parent[], int j) {
    if (parent[j] == -1) {
        printf("%d", j);
        return;
    }
    printPath(parent, parent[j]);
    printf(" -> %d", j);
}

// Dijkstra's Algorithm
void dijkstra(int src, int dest) {
    int dist[MAX], visited[MAX], parent[MAX];
    
    // Initialize
    for (int i = 0; i < n; i++) {
        dist[i] = INF;
        visited[i] = 0;
        parent[i] = -1;
    }
    dist[src] = 0;
    
    // Find shortest path
    for (int count = 0; count < n - 1; count++) {
        int u = minDistance(dist, visited);
        if (u == -1) break;
        visited[u] = 1;
        
        // Update distances
        for (int v = 0; v < n; v++) {
            if (!visited[v] && graph[u][v] != INF && dist[u] != INF &&
                dist[u] + graph[u][v] < dist[v]) {
                dist[v] = dist[u] + graph[u][v];
                parent[v] = u;
            }
        }
    }
    
    // Display results
    printf("\n=== ROUTING TABLE FROM ROUTER %d ===\n", src);
    printf("Destination\tDistance\n");
    for (int i = 0; i < n; i++) {
        printf("    %d\t\t", i);
        if (dist[i] == INF) printf("INF\n");
        else printf("%d\n", dist[i]);
    }
    
    // Check if destination is reachable
    if (dist[dest] == INF) {
        printf("\nNo path exists from Router %d to Router %d\n", src, dest);
        return;
    }
    
    // Display path details
    printf("\n=== SHORTEST PATH DETAILS ===\n");
    printf("Source: %d | Destination: %d | Cost: %d\n", src, dest, dist[dest]);
    printf("Path: ");
    printPath(parent, dest);
    printf("\n");
    
    // Simulate packet transmission
    printf("\n=== PACKET TRANSMISSION ===\n");
    int path[MAX], len = 0, j = dest;
    while (parent[j] != -1) {
        path[len++] = j;
        j = parent[j];
    }
    path[len++] = src;
    
    for (int i = len - 1; i > 0; i--) {
        printf("Hop %d: Router %d -> Router %d (Cost: %d)\n", 
               len - i, path[i], path[i-1], graph[path[i]][path[i-1]]);
    }
    printf("Packet delivered successfully!\n");
}

// Create network topology
void createGraph() {
    printf("\nEnter number of routers (max %d): ", MAX);
    scanf("%d", &n);
    
    if (n <= 0 || n > MAX) {
        printf("Invalid input!\n");
        return;
    }
    
    // Initialize graph
    for (int i = 0; i < n; i++) {
        for (int j = 0; j < n; j++) {
            graph[i][j] = (i == j) ? 0 : INF;
        }
    }
    
    // Input links
    printf("\nEnter links (enter -1 -1 -1 to stop):\n");
    printf("Format: router1 router2 cost\n");
    
    int u, v, cost;
    while (1) {
        printf("Link: ");
        scanf("%d %d %d", &u, &v, &cost);
        if (u == -1 || v == -1 || cost == -1) break;
        
        if (u >= 0 && u < n && v >= 0 && v < n && cost > 0) {
            graph[u][v] = cost;
            graph[v][u] = cost;  // Undirected graph
            printf("Added: Router %d <-> Router %d (Cost: %d)\n", u, v, cost);
        } else {
            printf("Invalid link!\n");
        }
    }
    
    // Display adjacency matrix
    printf("\n=== NETWORK TOPOLOGY (Adjacency Matrix) ===\n");
    printf("    ");
    for (int i = 0; i < n; i++) printf("%4d", i);
    printf("\n");
    
    for (int i = 0; i < n; i++) {
        printf("%2d: ", i);
        for (int j = 0; j < n; j++) {
            if (graph[i][j] == INF) printf(" INF");
            else printf("%4d", graph[i][j]);
        }
        printf("\n");
    }
}

// Main function
int main() {
    int choice, src, dest, created = 0;
    
    printf("\n===============================================\n");
    printf("   NETWORK PACKET ROUTING SYSTEM\n");
    printf("   Using Dijkstra's Algorithm\n");
    printf("===============================================\n");
    
    while (1) {
        printf("\n--- MENU ---\n");
        printf("1. Create Network\n");
        printf("2. Find Shortest Path\n");
        printf("3. Exit\n");
        printf("Choice: ");
        scanf("%d", &choice);
        
        switch (choice) {
            case 1:
                createGraph();
                created = 1;
                break;
                
            case 2:
                if (!created) {
                    printf("Please create network first!\n");
                    break;
                }
                printf("\nEnter source router: ");
                scanf("%d", &src);
                printf("Enter destination router: ");
                scanf("%d", &dest);
                
                if (src >= 0 && src < n && dest >= 0 && dest < n && src != dest) {
                    dijkstra(src, dest);
                } else {
                    printf("Invalid routers!\n");
                }
                break;
                
            case 3:
                printf("\nThank you for using Network Routing System!\n");
                exit(0);
                
            default:
                printf("Invalid choice!\n");
        }
    }
    
    return 0;
}
